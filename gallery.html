// üéµ –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞
const backgroundMusic = document.getElementById('backgroundMusic');

document.addEventListener('DOMContentLoaded', () => {
    if (backgroundMusic) {
        backgroundMusic.play().catch(() => {
            console.warn('–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º.');
        });
    }

    // –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –≥–∞–ª–µ—Ä–µ–∏
    loadStudents();
    loadGallery();
});

// ‚è≥ –¢–∞–π–º–µ—Ä
const countdownDate = new Date("June 15, 2025 18:00:00").getTime();

setInterval(() => {
    const now = new Date().getTime();
    const distance = countdownDate - now;

    if (distance > 0) {
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('days')?.innerText = days.toString().padStart(2, '0');
        document.getElementById('hours')?.innerText = hours.toString().padStart(2, '0');
        document.getElementById('minutes')?.innerText = minutes.toString().padStart(2, '0');
    } else {
        const message = document.createElement('h2');
        message.textContent = '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–∞—á–∞–ª–æ—Å—å!';
        document.querySelector('.countdown-container')?.replaceChildren(message);
    }
}, 1000);

// üéì –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
let students = {};
let isDataLoaded = false;

async function loadStudents() {
    try {
        const response = await fetch('students.json');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
        students = await response.json();
        isDataLoaded = true;
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
        console.error(error);
    }
}

// üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∏–¥–µ–æ
document.getElementById('accessForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!isDataLoaded) {
        alert('–î–∞–Ω–Ω—ã–µ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...');
        return;
    }

    const surname = document.getElementById('surname').value.toLowerCase().trim();
    const spinner = document.getElementById('spinner');
    const videoContainer = document.getElementById('videoContainer');

    spinner.style.display = 'block';
    videoContainer.innerHTML = '';

    try {
        if (students[surname]) {
            const student = students[surname];

            const greeting = document.createElement('h2');
            greeting.textContent = `üéâ –ü—Ä–∏–≤–µ—Ç, ${student.name}! üéâ`;
            greeting.className = 'greeting';

            const video = document.createElement('video');
            video.src = student.video;
            video.controls = true;
            video.style.width = '100%';
            video.style.borderRadius = '10px';

            video.addEventListener('error', () => {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ: ${student.video}`);
                alert('–í–∏–¥–µ–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.');
                spinner.style.display = 'none';
            });

            video.addEventListener('canplay', () => {
                spinner.style.display = 'none';
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            });

            videoContainer.appendChild(greeting);
            videoContainer.appendChild(video);
        } else {
            spinner.style.display = 'none';
            alert('–§–∞–º–∏–ª–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        }
    } catch (error) {
        spinner.style.display = 'none';
        console.error(error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
    }
});

// üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–µ—Ä–µ–∏
async function loadGallery() {
    const grid = document.getElementById('galleryGrid');
    if (!grid) return; // –≥–∞–ª–µ—Ä–µ–∏ –Ω–µ—Ç –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    try {
        const response = await fetch('gallery.json');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏');

        const photos = await response.json();

        if (!Array.isArray(photos) || photos.length === 0) {
            grid.innerHTML = '<p class="error-text">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.</p>';
            return;
        }

        photos.forEach(photo => {
            const wrapper = document.createElement('div');
            wrapper.className = 'gallery-item';

            const img = document.createElement('img');
            img.src = photo.url;
            img.alt = photo.caption || '–§–æ—Ç–æ —Å –≤—ã–ø—É—Å–∫–Ω–æ–≥–æ';
            img.className = 'gallery-photo';
            img.loading = 'lazy';

            wrapper.appendChild(img);

            if (photo.caption) {
                const caption = document.createElement('p');
                caption.className = 'gallery-caption';
                caption.textContent = photo.caption;
                wrapper.appendChild(caption);
            }

            grid.appendChild(wrapper);
        });
    } catch (error) {
        console.error(error);
        grid.innerHTML = '<p class="error-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>';
    }
}
